# Trade Potential Matching Logic Explained

## Overview

Trade potentials are automatically generated by matching customer product requirements with supplier capabilities, considering pricing and transport logistics. This document explains how the system works and why transport information might not appear in the Build Opportunity modal.

## How Trade Potentials Are Generated

### 1. Data Collection Phase

The system collects data from multiple tables:

- **Customer Requirements**: `customer_product_packaging_spec` - what products customers need
- **Supplier Capabilities**: `supplier_product_packaging_spec` - what products suppliers can provide
- **Existing Prices**: `current_supplier_prices` - current pricing information
- **Transport Routes**: `transporter_routes` + `transporter_route_price_bands` - available transport options
- **Customer Logistics**: `customer_logistics_capabilities` - how customers can receive/pickup goods
- **Certifications**: Customer requirements vs supplier certifications

### 2. Matrix Generation Process

For each customer requirement, the system:

1. **Finds matching suppliers** who can provide the same product packaging specification
2. **Checks certification compliance** - skips suppliers who don't meet customer certification requirements
3. **Evaluates pricing availability** - checks if supplier has current pricing for the product
4. **Determines transport logistics** - this is the complex part!

### 3. Transport Logic (Why Transport Might Be Missing)

Transport availability is determined through a **4-step hierarchy**:

#### Step 1: Same Location Check
```
If supplier hub = customer pickup/delivery hub
→ Transport Solution: "SAME_LOCATION"
→ Duration: 0 days, Cost: €0
```

#### Step 2: Supplier Delivery Check
```
If supplier offers delivery AND customer can receive at supplier's hub
→ Transport Solution: "SUPPLIER_DELIVERY"
→ Duration: 1 day, Cost: €0 (included in supplier price)
```

#### Step 3: Third-Party Transport Check
```
If transport route exists FROM supplier hub TO customer delivery hub
→ Transport Solution: "THIRD_PARTY_TRANSPORT"
→ Uses actual transporter data with real costs and duration
```

#### Step 4: No Transport Available
```
If none of the above conditions are met
→ hasTransport: false
→ Transport card will NOT appear in Build Opportunity modal
```

## Trade Potential Status Logic

Based on pricing and transport availability:

| Has Price | Has Transport | Status | Description |
|-----------|---------------|--------|-------------|
| ✅ | ✅ | `complete` | Ready for opportunity creation |
| ✅ | ❌ | `missing_transport` | Has pricing but no transport solution |
| ❌ | ✅ | `missing_price` | Has transport but no pricing |
| ❌ | ❌ | `missing_both` | Neither pricing nor transport available |

## Why Transport Card Might Not Show

The transport card in the Build Opportunity modal only appears when:

```typescript
potential?.transportRoute && // Transport route exists
```

### Common Reasons for Missing Transport:

1. **No Transport Routes Configured**
   - No transporter routes exist between supplier hub and customer delivery hubs
   - Check: `/my/transporters` → Routes tab

2. **Customer Logistics Not Configured**
   - Customer has no logistics capabilities configured
   - Customer can't pickup Ex Works or receive delivery
   - Check: Customer details → Logistics tab

3. **Supplier Hub Mismatch**
   - Supplier price is at Hub A
   - Customer delivery capability is at Hub B
   - No transport route exists A → B

4. **Inactive Data**
   - Transport route exists but is marked inactive
   - Transporter exists but is marked inactive

## Key Dependencies

### For Transport to Show:
1. **Supplier must have pricing** with a specific `hub_id`
2. **Customer must have logistics capabilities** (pickup or delivery)
3. **Either:**
   - Same hub (supplier hub = customer hub)
   - Supplier delivery capability matches customer delivery hub
   - Third-party transport route exists (supplier hub → customer delivery hub)

### Database Tables Involved:
- `supplier_prices` → Contains `hub_id` and `delivery_mode`
- `customer_logistics_capabilities` → Contains pickup/delivery preferences
- `transporter_routes` → Contains available transport paths
- `transporter_route_price_bands` → Contains transport pricing

## Debugging Steps

If transport is not showing in Build Opportunity modal:

1. **Check Console Logs**: Look for transport matching debug output
2. **Verify Supplier Pricing**: Ensure supplier has active price with hub_id
3. **Check Customer Logistics**: Ensure customer has delivery/pickup capabilities
4. **Verify Transport Routes**: Check if routes exist between relevant hubs
5. **Check Active Status**: Ensure transporters and routes are active

## Example Scenarios

### Scenario 1: Complete Match
```
Customer: McDonald's Netherlands (can receive delivery at Amsterdam Hub)
Supplier: Fresh Farms Spain (has pricing Ex Works at Madrid Hub)
Transport: DHL route Madrid → Amsterdam (5 days, €50/pallet)
Result: Complete trade potential with transport card showing
```

### Scenario 2: Missing Transport
```
Customer: McDonald's UK (can receive delivery at London Hub)
Supplier: Fresh Farms Spain (has pricing Ex Works at Madrid Hub)
Transport: No route configured Madrid → London
Result: "missing_transport" status, no transport card
```

### Scenario 3: Same Location
```
Customer: Tesco Netherlands (can pickup Ex Works at Amsterdam Hub)
Supplier: Local Dutch Farm (has pricing Ex Works at Amsterdam Hub)
Transport: Same location, no transporter needed
Result: Transport shows as "Same Location" with 0 days, €0 cost
```

This complex matching system ensures that only realistic, actionable trade opportunities are marked as "complete" and show full transport information.